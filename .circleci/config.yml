version: 2
jobs:
  build:
    machine: true
    steps:
      - checkout
      - run:
          name: Start container and verify it's working
          command: |
            set -x
            docker-compose -f docker-compose-circleci.yml up -d
            docker run --network project_default \
              appropriate/curl --retry 30 --retry-delay 2 --retry-connrefused http://web:80/common/version
      - run:
          name: Running unit tests
          command: |
            docker-compose -f docker-compose-circleci.yml exec web sh -c 'make test-unit test-api'
      - run:
          name: Running portal tests
          command: |
            docker-compose -f docker-compose-circleci.yml exec test sh -c 'TEST_PORTAL_URL=http://portal:80 TEST_PORTAL_USERNAME=root TEST_PORTAL_PASSWD=desinventar make test-portal'
      - run:
          name: Running api tests
          command: |
            docker-compose -f docker-compose-circleci.yml exec test sh -c 'TEST_API_URL=http://web:80 make test-api'
      - run:
          name: Running e2e tests
          command: |
            docker-compose -f docker-compose-circleci.yml exec test sh -c 'TEST_WEB_URL=http://web:80 make test-e2e'
